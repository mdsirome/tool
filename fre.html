<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Playlist Status Checker · Sirome TV</title>
    <!-- Favicon & Open Graph -->
    <link rel="icon" href="https://i.postimg.cc/d1hHy4ss/11.png" type="image/png">
    <meta property="og:image" content="https://i.postimg.cc/d1hHy4ss/11.png">
    <!-- Font Awesome 6 (free) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts: Inter + Sansita One for footer -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sansita+One&display=swap" rel="stylesheet">
    <!-- Clappr Core & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/level-selector@0.2.0/dist/level-selector.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.0.1/dist/hlsjs-playback.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clappr-pip-mode@1.1.0/dist/clappr-pip-mode.min.js"></script>
    <!-- HLS.js for better HLS support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0c0f;
            color: #e5e9f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: all 0.2s;
            overflow: hidden;
        }

        .glass-card {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            background: rgba(18, 22, 28, 0.92);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid #2e3a48;
            border-radius: 36px;
            padding: 24px 22px;
            box-shadow: 0 25px 45px -12px #00000080;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1 {
            font-size: 1.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #f0f6fc;
            margin-bottom: 6px;
            text-align: center;
        }
        h1 i {
            color: #3ecf8e;
        }
        .sub {
            color: #9ab8d9;
            margin-bottom: 24px;
            font-weight: 500;
            border-left: 4px solid #3ecf8e;
            padding-left: 18px;
            font-size: 0.95rem;
            text-align: left;
        }

        .url-box {
            display: flex;
            align-items: center;
            background: #1e2630;
            border-radius: 60px;
            border: 1px solid #384754;
            padding: 4px 4px 4px 24px;
            margin-bottom: 20px;
            flex: 1;
        }
        .url-box i.fa-link {
            color: #79b8ff;
            margin-right: 10px;
        }
        .url-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: #f0f6fc;
            font-size: 1rem;
            padding: 16px 0;
            outline: none;
        }
        .url-box input::placeholder {
            color: #6f859c;
        }
        .clear-btn {
            background: transparent;
            border: none;
            color: #a2bcdb;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 12px;
            display: flex;
            align-items: center;
        }
        .clear-btn:hover {
            color: #f98f8f;
        }
        .action-btn {
            background: #2f3e52;
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: 0.15s;
            white-space: nowrap;
            border: 1px solid #4f637b;
            margin-left: 5px;
        }
        .action-btn.reset-btn {
            background: #442f2f;
            border-color: #8b4e4e;
        }
        .action-btn:hover {
            filter: brightness(1.2);
        }

        .drag-area {
            border: 2px dashed #3d5068;
            border-radius: 36px;
            background: #151e26;
            padding: 26px 20px;
            text-align: center;
            transition: 0.2s;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .drag-area.active {
            border-color: #3ecf8e;
            background: #1e2f2a;
        }
        .drag-area i {
            font-size: 2.8rem;
            color: #6d8eb0;
        }
        .drag-text {
            font-weight: 600;
            font-size: 1.2rem;
            color: #ccddec;
        }
        .drag-area span {
            color: #8aa2c0;
        }
        .hidden-file-input {
            display: none;
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0 18px;
        }
        .stats {
            background: #1c2632;
            border-radius: 40px;
            padding: 12px 26px;
            font-weight: 600;
            color: #ceddec;
            border: 1px solid #35475a;
            font-size: 0.95rem;
        }
        .stats i {
            color: #3ecf8e;
            margin-right: 6px;
        }
        .selection-tools {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            background: #262f3c;
            border: 1px solid #41566e;
            padding: 10px 22px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #d4e2f5;
            transition: 0.1s;
        }
        .btn-primary {
            background: #1f3d58;
            border-color: #3880b0;
            color: white;
        }
        .btn-success {
            background: #1c5537;
            border-color: #3ecf8e;
            color: white;
        }
        .btn-outline {
            background: transparent;
            border: 1.5px solid #50799e;
        }
        .btn:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
        }

        .channels-grid {
            background: #11181f;
            border-radius: 32px;
            padding: 16px 10px;
            max-height: 45vh;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            border: 1px solid #26323f;
            margin-bottom: 16px;
        }
        .channels-grid::-webkit-scrollbar {
            display: none;
        }

        .channel-row {
            display: flex;
            align-items: center;
            background: #1c2733;
            margin: 10px 4px;
            padding: 8px 16px 8px 20px;
            border-radius: 50px;
            border: 1px solid #31475c;
            flex-wrap: wrap;
            gap: 10px;
        }
        .channel-row:hover {
            background: #23303e;
            border-color: #4e799b;
        }
        .channel-select {
            margin-right: 8px;
        }
        .channel-select input {
            width: 18px;
            height: 18px;
            accent-color: #3ecf8e;
        }
        .channel-logo {
            width: 75px;
            height: 75px; /* 75*75 as requested - square logo */
            border-radius: 7%;
            background: #233344;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            object-fit: cover; /* This ensures the image covers the entire area */
            border: 2px solid #4f6a83;
            margin-right: 14px;
        }
        .channel-info {
            flex: 2;
            min-width: 160px;
        }
        .channel-name {
            font-weight: 700;
            font-size: 1rem;
            color: #eef5ff;
        }
        .channel-url-preview {
            font-size: 0.7rem;
            color: #99b5d3;
            max-width: 280px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .status-led {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 6px;
        }
        .led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: 0 0 10px;
        }
        .led.green { background: #2ecc71; box-shadow: 0 0 12px #2ecc71; }
        .led.red { background: #e74c3c; box-shadow: 0 0 12px #e74c3c; }
        .led.yellow { background: #f39c12; box-shadow: 0 0 12px #f39c12; }
        .led.gray { background: #546979; box-shadow: none; }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .copy-btn, .play-btn {
            background: #263a4a;
            border: 1px solid #426280;
            padding: 8px 14px;
            border-radius: 32px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #d5e9ff;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .play-btn {
            background: #1b4b3b;
            border-color: #3ecf8e;
            color: white;
        }
        .copy-btn:hover { background: #2f4a62; }
        .play-btn:hover { background: #246b4f; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
            visibility: hidden;
            opacity: 0;
            transition: 0.2s ease;
        }
        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: #0f1a24;
            width: 100%;
            max-width: 900px;
            border-radius: 36px;
            border: 1px solid #3b5d7a;
            box-shadow: 0 30px 50px #00000080;
            padding: 18px;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .modal-header h3 {
            color: #b5d9ff;
            font-size: 1.3rem;
            font-weight: 600;
        }
        .close-modal {
            background: transparent;
            border: none;
            color: #c0d8f0;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0 8px;
        }
        .close-modal:hover {
            color: #f19595;
        }
        #player {
            width: 100%;
            height: 0;
            padding-bottom: 45%;
            background: black;
            border-radius: 24px;
            overflow: hidden;
            border: 2px solid #2d506d;
        }
        .player-url-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .player-url-row input {
            flex: 1;
            background: #1b2a38;
            border: 1px solid #3b6180;
            border-radius: 40px;
            padding: 14px 20px;
            color: white;
            font-size: 0.95rem;
            outline: none;
            min-width: 180px;
        }
        .player-url-row button {
            background: #2f4e72;
            border: none;
            padding: 14px 24px;
            border-radius: 40px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        .player-url-row button:hover {
            background: #3e628a;
        }

        .footer {
            text-align: center;
            padding: 14px 10px;
            background-color: #0c0f13;
            margin-top: 15px;
            color: #fff;
            font-family: 'Sansita One', sans-serif;
            border-radius: 60px;
            border: 1px solid #29394a;
            width: 100%;
        }

        @media (max-width: 600px) {
            .channel-row {
                flex-direction: column;
                align-items: flex-start;
                border-radius: 30px;
            }
            .action-buttons {
                margin-left: 0;
                width: 100%;
                justify-content: flex-start;
            }
            .status-led {
                margin-left: 0;
            }
            .glass-card {
                padding: 18px;
            }
            #player {
                padding-bottom: 56%;
            }
        }
        @media (max-height: 500px) and (orientation: landscape) {
            .modal-content {
                max-width: 80%;
            }
            #player {
                padding-bottom: 40%;
            }
        }
    </style>
</head>
<body>
    <div class="glass-card">
        <h1><i class="fas fa-list-check"></i> Playlist Status Checker</h1>
        <div class="sub">Drag/paste or upload file – Green LED = playable (200 OK / m3u8, mp4, ts, mpd)</div>

        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            <div class="url-box" style="margin-bottom: 0; flex: 1;">
                <i class="fas fa-link"></i>
                <input type="url" id="playlistUrl" placeholder="https://example.com/playlist.m3u or .txt">
                <button class="clear-btn" id="clearInputBtn"><i class="fas fa-times-circle"></i></button>
                <button class="action-btn" id="loadUrlBtn"><i class="fas fa-cloud-download-alt"></i> Load</button>
            </div>
            <button class="action-btn reset-btn" id="resetAllBtn"><i class="fas fa-undo-alt"></i> Reset</button>
        </div>

        <div class="drag-area" id="dragArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <div class="drag-text">Drop file or click here</div>
            <span>Supports .m3u, .m3u8, .txt (M3U format)</span>
            <input type="file" id="fileInput" accept=".m3u,.m3u8,.txt,audio/x-mpegurl" class="hidden-file-input">
        </div>

        <div class="status-bar">
            <div class="stats"><i class="fas fa-list-ul"></i> <span id="totalCount">0</span> channels · <span id="greenCount">0</span> green · <span id="redCount">0</span> red</div>
            <div class="selection-tools">
                <button class="btn btn-outline" id="selectAllGreen"><i class="fas fa-check-double"></i> Select all green</button>
                <button class="btn btn-outline" id="deselectAll"><i class="fas fa-times"></i> Deselect all</button>
                <button class="btn btn-success" id="downloadSelected"><i class="fas fa-file-download"></i> Download selected M3U</button>
            </div>
        </div>

        <div class="channels-grid" id="channelsContainer">
            <div style="padding: 40px; text-align: center; color: #859eb9;"><i class="fas fa-music"></i> Paste URL or drop file</div>
        </div>

        <div class="footer">
            <p>Powered by Sirome TV 2022 - 2026</p>
        </div>
    </div>

    <div class="modal-overlay" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-play-circle" style="color:#3ecf8e;"></i> Now Playing</h3>
                <button class="close-modal" id="closeModalBtn"><i class="fas fa-times"></i></button>
            </div>
            <div id="player"></div>
            <div class="player-url-row">
                <input type="text" id="playerStreamUrl" placeholder="Enter or paste stream URL ..." value="">
                <button id="loadStreamBtn"><i class="fas fa-sync-alt"></i> Load / Play</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            let channels = [];
            let checkStatusMap = new Map();
            let abortControllers = new Map();

            const urlInput = document.getElementById('playlistUrl');
            const clearBtn = document.getElementById('clearInputBtn');
            const loadUrlBtn = document.getElementById('loadUrlBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');
            const dragArea = document.getElementById('dragArea');
            const fileInput = document.getElementById('fileInput');
            const channelsContainer = document.getElementById('channelsContainer');
            const totalSpan = document.getElementById('totalCount');
            const greenSpan = document.getElementById('greenCount');
            const redSpan = document.getElementById('redCount');
            const selectAllGreenBtn = document.getElementById('selectAllGreen');
            const deselectAllBtn = document.getElementById('deselectAll');
            const downloadBtn = document.getElementById('downloadSelected');

            const modalOverlay = document.getElementById('videoModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const playerStreamUrl = document.getElementById('playerStreamUrl');
            const loadStreamBtn = document.getElementById('loadStreamBtn');
            let clapprPlayer = null;

            function closeModal() {
                modalOverlay.classList.remove('active');
                if (clapprPlayer) {
                    clapprPlayer.destroy();
                    clapprPlayer = null;
                }
            }

            function openPlayerWithUrl(streamUrl, logo = '') {
                playerStreamUrl.value = streamUrl;
                modalOverlay.classList.add('active');

                if (clapprPlayer) {
                    clapprPlayer.destroy();
                }

                try {
                    // Enhanced Clappr configuration for better HLS support
                    clapprPlayer = new Clappr.Player({
                        source: streamUrl,
                        parentId: "#player",
                        autoPlay: true,
                        mute: false,
                        width: "100%",
                        height: "100%",
                        plugins: [
                            HlsjsPlayback, 
                            LevelSelector,
                            (window.ClapprPipMode ? window.ClapprPipMode.PipButton : null)
                        ].filter(Boolean),
                        mediacontrol: { 
                            seekbar: "#e74c3c", 
                            buttons: "#ecf0f1",
                            volume: true
                        },
                        poster: "https://i.postimg.cc/cJBhWxv5/3122396-icoCopy.png",
                        hlsjsConfig: {
                            enableWorker: true,
                            debug: false,
                            overrideNative: true,
                            // Better streaming options
                            maxBufferLength: 30,
                            maxMaxBufferLength: 60,
                            liveSyncDurationCount: 3,
                            liveMaxLatencyDurationCount: 5
                        },
                        // Force HLS playback for m3u8 files
                        playback: {
                            hlsjsConfig: {
                                enableWorker: true,
                                overrideNative: true
                            }
                        }
                    });
                    
                    // Add event listener for playback errors
                    clapprPlayer.on(Clappr.Events.PLAYER_ERROR, (error) => {
                        console.error('Player error:', error);
                        // Try alternative method if Clappr fails
                        if (streamUrl.includes('.m3u8')) {
                            tryNativeHLS(streamUrl);
                        }
                    });
                    
                } catch (e) {
                    console.error('Player initialization error:', e);
                    // Fallback to native HLS
                    tryNativeHLS(streamUrl);
                }
            }
            
            // Fallback function using native HLS or video element
            function tryNativeHLS(streamUrl) {
                const playerDiv = document.getElementById('player');
                playerDiv.innerHTML = ''; // Clear the div
                
                // Create a simple video element
                const videoElement = document.createElement('video');
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                videoElement.style.backgroundColor = '#000';
                videoElement.controls = true;
                videoElement.autoplay = true;
                
                // Check if HLS is supported natively or use HLS.js
                if (Hls.isSupported() && streamUrl.includes('.m3u8')) {
                    const hls = new Hls();
                    hls.loadSource(streamUrl);
                    hls.attachMedia(videoElement);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        videoElement.play().catch(e => console.log('Autoplay prevented:', e));
                    });
                } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari native HLS support
                    videoElement.src = streamUrl;
                } else {
                    // Try direct play as fallback
                    videoElement.src = streamUrl;
                }
                
                playerDiv.appendChild(videoElement);
            }

            loadStreamBtn.addEventListener('click', () => {
                const newUrl = playerStreamUrl.value.trim();
                if (!newUrl) return;
                
                // Clear player container and try with new URL
                if (clapprPlayer) {
                    clapprPlayer.destroy();
                    clapprPlayer = null;
                }
                
                const playerDiv = document.getElementById('player');
                playerDiv.innerHTML = ''; // Clear any existing content
                
                openPlayerWithUrl(newUrl);
            });

            closeModalBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });

            function parseM3U(content) {
                const lines = content.split(/\r?\n/);
                const channels = [];
                let currentName = 'Unnamed';
                let currentLogo = '';

                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    if (line.startsWith('#EXTINF:')) {
                        const logoMatch = line.match(/tvg-logo="([^"]*)"/i);
                        currentLogo = logoMatch ? logoMatch[1] : '';
                        const nameMatch = line.match(/,(.+)$/);
                        currentName = nameMatch ? nameMatch[1].trim() : 'Unnamed';
                    } else if (line && !line.startsWith('#')) {
                        channels.push({
                            name: currentName,
                            url: line,
                            logo: currentLogo || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentName)}&background=2b7a4b&color=fff&size=75&length=1&bold=true`,
                        });
                        currentName = 'Unnamed';
                        currentLogo = '';
                    }
                }
                return channels;
            }

            function renderChannels() {
                if (!channels.length) {
                    channelsContainer.innerHTML = `<div style="padding:40px;text-align:center;color:#8aaaca;"><i class="fas fa-folder-open"></i> No channels found</div>`;
                    updateStats();
                    return;
                }

                let html = '';
                channels.forEach((ch) => {
                    const status = checkStatusMap.get(ch.url);
                    let ledClass = 'led gray';
                    if (status === 'checking') ledClass = 'led yellow';
                    else if (status === true) ledClass = 'led green';
                    else if (status === false) ledClass = 'led red';

                    const checkedAttr = ch.selected ? 'checked' : '';

                    html += `<div class="channel-row" data-url="${ch.url}">
                        <div class="channel-select">
                            <input type="checkbox" class="channel-checkbox" data-url="${ch.url}" ${checkedAttr}>
                        </div>
                        <img class="channel-logo" src="${ch.logo}" alt="logo" loading="lazy" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(ch.name)}&background=2b7a4b&color=fff&size=75&length=1&bold=true';">
                        <div class="channel-info">
                            <div class="channel-name">${ch.name}</div>
                            <div class="channel-url-preview">${ch.url.substring(0,70)}${ch.url.length>70?'…':''}</div>
                        </div>
                        <div class="status-led">
                            <span class="${ledClass}"></span>
                        </div>
                        <div class="action-buttons">
                            <button class="copy-btn" data-url="${ch.url}"><i class="far fa-copy"></i> Copy</button>
                            <button class="play-btn" data-url="${ch.url}" data-logo="${ch.logo}"><i class="fas fa-play"></i> Play</button>
                        </div>
                    </div>`;
                });
                channelsContainer.innerHTML = html;

                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const url = e.currentTarget.dataset.url;
                        navigator.clipboard.writeText(url).then(() => alert('URL copied'));
                    });
                });

                document.querySelectorAll('.play-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const url = e.currentTarget.dataset.url;
                        const logo = e.currentTarget.dataset.logo;
                        openPlayerWithUrl(url, logo);
                    });
                });

                document.querySelectorAll('.channel-checkbox').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        const url = e.target.dataset.url;
                        const ch = channels.find(c => c.url === url);
                        if (ch) ch.selected = e.target.checked;
                    });
                });
                updateStats();
            }

            function updateStats() {
                const total = channels.length;
                const green = channels.filter(ch => checkStatusMap.get(ch.url) === true).length;
                const red = channels.filter(ch => checkStatusMap.get(ch.url) === false).length;
                totalSpan.innerText = total;
                greenSpan.innerText = green;
                redSpan.innerText = red;
            }

            async function checkChannel(url) {
                if (abortControllers.has(url)) abortControllers.get(url).abort();
                const controller = new AbortController();
                abortControllers.set(url, controller);
                checkStatusMap.set(url, 'checking');
                renderChannels();

                try {
                    const res = await fetch(url, { 
                        method: 'GET', 
                        headers: { 'Range': 'bytes=0-1' }, 
                        signal: controller.signal, 
                        mode: 'cors' 
                    });
                    if (res.ok || res.status === 206) checkStatusMap.set(url, true);
                    else checkStatusMap.set(url, false);
                } catch (err) {
                    if (err.name === 'AbortError') return;
                    try {
                        const headRes = await fetch(url, { 
                            method: 'HEAD', 
                            signal: controller.signal 
                        });
                        checkStatusMap.set(url, headRes.ok);
                    } catch {
                        checkStatusMap.set(url, false);
                    }
                } finally {
                    abortControllers.delete(url);
                    renderChannels();
                }
            }

            function checkAllChannels() {
                channels.forEach((ch, idx) => {
                    setTimeout(() => {
                        if (!abortControllers.has(ch.url)) checkChannel(ch.url);
                    }, idx * 100);
                });
            }

            async function loadFromUrl(url) {
                if (!url) return;
                try {
                    const resp = await fetch(url);
                    const text = await resp.text();
                    loadPlaylistContent(text);
                } catch {
                    alert('Failed to load playlist');
                }
            }

            function loadFromFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => loadPlaylistContent(e.target.result);
                reader.readAsText(file);
            }

            function loadPlaylistContent(content) {
                for (let [_, ctrl] of abortControllers) ctrl.abort();
                abortControllers.clear();
                const parsed = parseM3U(content);
                channels = parsed.map(ch => ({ ...ch, selected: false }));
                checkStatusMap.clear();
                renderChannels();
                if (channels.length) checkAllChannels();
                else channelsContainer.innerHTML = `<div style="padding:40px;text-align:center;">No valid streams found</div>`;
            }

            function resetEverything() {
                for (let [_, ctrl] of abortControllers) ctrl.abort();
                abortControllers.clear();
                channels = [];
                checkStatusMap.clear();
                urlInput.value = '';
                renderChannels();
                closeModal();
            }

            clearBtn.addEventListener('click', () => { urlInput.value = ''; });
            loadUrlBtn.addEventListener('click', () => { if (urlInput.value.trim()) loadFromUrl(urlInput.value.trim()); });
            resetAllBtn.addEventListener('click', resetEverything);
            urlInput.addEventListener('paste', () => setTimeout(() => { if (urlInput.value.trim()) loadFromUrl(urlInput.value.trim()); }, 50));
            urlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') loadUrlBtn.click(); });

            dragArea.addEventListener('click', () => fileInput.click());
            dragArea.addEventListener('dragover', (e) => { e.preventDefault(); dragArea.classList.add('active'); });
            dragArea.addEventListener('dragleave', () => dragArea.classList.remove('active'));
            dragArea.addEventListener('drop', (e) => {
                e.preventDefault(); dragArea.classList.remove('active');
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.m3u') || file.name.endsWith('.m3u8') || file.name.endsWith('.txt'))) loadFromFile(file);
                else alert('Please drop .m3u or .txt file');
            });
            fileInput.addEventListener('change', () => { if (fileInput.files.length) loadFromFile(fileInput.files[0]); });

            selectAllGreenBtn.addEventListener('click', () => {
                channels.forEach(ch => { ch.selected = checkStatusMap.get(ch.url) === true; });
                renderChannels();
            });
            deselectAllBtn.addEventListener('click', () => {
                channels.forEach(ch => ch.selected = false);
                renderChannels();
            });
            downloadBtn.addEventListener('click', () => {
                const selected = channels.filter(ch => ch.selected);
                if (!selected.length) return alert('No channel selected');
                const count = selected.length;
                const today = new Date();
                const day = String(today.getDate()).padStart(2,'0');
                const month = String(today.getMonth()+1).padStart(2,'0');
                const year = today.getFullYear();
                const dateStr = `${day}-${month}-${year}`;
                const filename = `Sirome TV (${count})-${dateStr}.m3u`;

                let m3u = '#EXTM3U\n';
                selected.forEach(ch => { 
                    m3u += `#EXTINF:-1 tvg-logo="${ch.logo}",${ch.name}\n${ch.url}\n`; 
                });
                const blob = new Blob([m3u], { type: 'audio/x-mpegurl' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
            });

            updateStats();
        })();
    </script>
</body>
</html>
