<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Invoice</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    .invoice-container {
      width: 794px; /* A4 width in px @96dpi */
      min-height: 1123px; /* A4 height */
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .header-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    /* ==== LOGO STYLE ==== */
    .logo-box {
      width: 100px;
      height: 100px;
      cursor: pointer;
      perspective: 800px;
    }
    .logo-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 12px;
      background: #f3f4f6;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      transition: transform 0.4s ease, box-shadow 0.4s ease;
      transform-style: preserve-3d;
    }
    .logo-box img:hover {
      transform: rotateY(15deg) rotateX(10deg) scale(1.05);
      box-shadow: 0 12px 25px rgba(0,0,0,0.5);
    }
    .company-info {
      max-width: 55%;
    }
    .company-info input {
      border: none;
      border-bottom: 1px solid #999;
      width: 100%;
      font-size: 18px;
      margin-bottom: 6px;
    }
    #companyName { font-size:22px; font-weight: bold; }
    .invoice-meta {
      text-align: right;
    }
    .invoice-meta input {
      border: none;
      border-bottom: 1px solid #999;
      text-align: right;
      margin-bottom: 6px;
    }
    .section { margin-top: 20px; }
    .section h3 {
      margin-bottom: 8px;
      font-size: 16px;
      border-bottom: 2px solid #444;
      display: inline-block;
      padding-bottom: 2px;
    }
    .buyer-info input {
      width: 90%;
      border: none;
      border-bottom: 1px solid #999;
      margin-bottom: 6px;
      font-size: 14px;
    }
    table {
      width: 98%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 2px solid black;
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }
    td input {
      border: none;
      width: 100%;
      text-align: left;
    }
    .qty-input { width: 50px; }
    .price-input { width: 80px; }
    .remove-btn { color: red; font-weight: bold; cursor: pointer; }
    
    .totals { margin-top: 15px; text-align: right; font-size: 14px; }
    .totals div { margin-bottom: 5px;font-weight: bold; }
    #due { font-size: 18px; font-weight: bold; color: #dc2626; }
    .actions { margin-top: 20px; text-align: center; }
    .actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 4px;
      font-size: 14px;
    }
    .save-btn { background: #2563eb; color: #fff; }
    .add-product-btn { background: #16a34a; color: #fff; font-size: 20px; }
    .status-btn { background: #e5e7eb; border: 1px solid #999; }
    .status-btn.active-paid { background: #16a34a; color: #fff; }
    .status-btn.active-due { background: #dc2626; color: #fff; }
    .status-label {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
    }
    /* Signature Section */
    .signature-section {
      display: flex;
      justify-content: space-between;
      margin-top: 50px;
    }
    .signature-box { width: 45%; text-align: center; }
    .signature-line { margin-top: 60px; border-top: 1px solid #000; width: 100%; }
    canvas {
      border: 1px solid #000;
      border-radius: 6px;
      width: 100%;
      height: 150px;
      touch-action: none;
    }
  </style>
</head>
<body>
<div class="invoice-container" id="invoice">
  <h2>Invoice</h2>
  <div class="header-section">
       <!-- ======= LOGO UPLOAD ======= -->
    <div class="logo-box" onclick="document.getElementById('logoUpload').click()">
      <img id="companyLogo" src="https://i.postimg.cc/MpT3zDwG/GH-1-Copy.png" alt="Company Logo">
      <input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="changeLogo(event)">
    </div>
    <div class="company-info">
      <input type="text" id="companyName" value="Gadget Home">
      <input type="text" id="companyAddress" value="C.D.A Market, Reaz Uddin Bazar, Chattogram">
      <input type="text" id="companyMobile" value="880170000000">
    </div>
    <div class="invoice-meta">
      <label>Date: <input type="date" id="invoiceDate"></label><br>
      <label>Memo: <input type="text" id="memoNumber"></label>
    </div>
  </div>

  <!-- Buyer Info -->
  <div class="section buyer-info">
    <h3>Buyer Info</h3>
    <input type="text" placeholder="Name:" id="buyerName">
    <input type="text" placeholder="Address:" id="buyerAddress">
    <input type="text" placeholder="Buyer Mobile No:" id="buyerMobile">
  </div>

  <!-- Products -->
  <div class="section">
    <h3>Products</h3>
    <table>
      <thead>
        <tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr>
      </thead>
      <tbody id="productBody"></tbody>
    </table>
    <button class="add-product-btn" onclick="addProduct()">+ Add Product</button>
  </div>

  <!-- Totals -->
  <div class="section totals">
    <div>Subtotal: <span id="subtotal">0.00</span></div>
    <div>Discount %: <input type="number" id="discount" value="0" min="0" max="100" oninput="calculateTotal()" style="width:60px;"> 
         Amount: <span id="discountAmount">0.00</span></div>
    <div>Total After Discount: <span id="totalAfterDiscount">0.00</span></div>
    <div>Advance: <input type="number" id="advance" value="0" min="0" oninput="calculateTotal()" style="width:80px;"> 
         Paid: <span id="advancePaid">0.00</span></div>
    <div>Due: <span id="due">0.00</span></div>
  </div>

  <div class="status-label" id="statusLabel">Status: Due</div>

  <!-- Signatures -->
  <div class="signature-section">
    <div class="signature-box">
      <div class="signature-line"></div>
      Authorized Signature
    </div>
    <div class="signature-box">
      <canvas id="signaturePad"></canvas><br>
      <button onclick="clearSignature()">Clear</button>
      <div style="margin-top:10px;">Customer Signature</div>
    </div>
  </div>

  <!-- Actions -->
  <div class="actions">
    <button class="status-btn" id="paidBtn" onclick="setStatus('paid')">Paid</button>
    <button class="status-btn" id="dueBtn" onclick="setStatus('due')">Due</button>
    <br>
    <button class="save-btn" onclick="downloadInvoice('png')">Save as PNG</button>
    <button class="save-btn" onclick="downloadInvoice('jpg')">Save as JPG</button>
    <button class="save-btn" onclick="downloadInvoice('pdf')">Save as PDF</button>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  document.getElementById('invoiceDate').valueAsDate = new Date();

  function changeLogo(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => document.getElementById('companyLogo').src = e.target.result;
      reader.readAsDataURL(file);
    }
  }

  function addProduct() {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" placeholder="Product" oninput="calculateTotal()"></td>
      <td><input type="number" class="qty-input" value="1" min="1" oninput="calculateTotal()"></td>
      <td><input type="number" class="price-input" value="" min="0" step="0.01" oninput="calculateTotal()"></td>
      <td class="product-total">0.00</td>
      <td><span class="remove-btn" onclick="this.closest('tr').remove(); calculateTotal();">&times;</span></td>
    `;
    document.getElementById('productBody').appendChild(row);
    calculateTotal();
  }
  addProduct();

  function calculateTotal() {
    let subtotal = 0;
    document.querySelectorAll('#productBody tr').forEach(row => {
      const qty = parseFloat(row.children[1].querySelector('input').value) || 0;
      const price = parseFloat(row.children[2].querySelector('input').value) || 0;
      const total = qty * price;
      row.children[3].innerText = total.toFixed(2);
      subtotal += total;
    });
    const discountPercent = parseFloat(document.getElementById('discount').value) || 0;
    const discountAmount = subtotal * discountPercent / 100;
    const totalAfterDiscount = subtotal - discountAmount;
    const advance = parseFloat(document.getElementById('advance').value) || 0;
    const due = totalAfterDiscount - advance;

    document.getElementById('subtotal').innerText = subtotal.toFixed(2);
    document.getElementById('discountAmount').innerText = discountAmount.toFixed(2);
    document.getElementById('totalAfterDiscount').innerText = totalAfterDiscount.toFixed(2);
    document.getElementById('advancePaid').innerText = advance.toFixed(2);
    document.getElementById('due').innerText = due.toFixed(2);
  }

  function setStatus(type) {
    const paidBtn = document.getElementById('paidBtn');
    const dueBtn = document.getElementById('dueBtn');
    const statusLabel = document.getElementById('statusLabel');
    paidBtn.classList.remove('active-paid');
    dueBtn.classList.remove('active-due');
    if (type === 'paid') {
      paidBtn.classList.add('active-paid');
      statusLabel.innerText = "Status: Paid";
      statusLabel.style.color = "#16a34a";
    } else {
      dueBtn.classList.add('active-due');
      statusLabel.innerText = "Status: Due";
      statusLabel.style.color = "#dc2626";
    }
  }

  // ===== Signature Pad =====
  const canvas = document.getElementById("signaturePad");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  function startDraw(e) {
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(getX(e), getY(e));
  }
  function draw(e) {
    if (!drawing) return;
    ctx.lineTo(getX(e), getY(e));
    ctx.stroke();
  }
  function endDraw() { drawing = false; }

  function getX(e) { return e.touches ? e.touches[0].clientX - canvas.getBoundingClientRect().left : e.offsetX; }
  function getY(e) { return e.touches ? e.touches[0].clientY - canvas.getBoundingClientRect().top : e.offsetY; }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseout", endDraw);

  canvas.addEventListener("touchstart", startDraw);
  canvas.addEventListener("touchmove", draw);
  canvas.addEventListener("touchend", endDraw);

  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  async function downloadInvoice(type) {
    const node = document.getElementById('invoice');
    const inputs = node.querySelectorAll("input[type='text'], input[type='number'], input[type='date']");
    const replaced = [];
    inputs.forEach(input => {
      const span = document.createElement("span");
      span.innerText = input.value || input.placeholder;
      span.style.display = "inline-block";
      span.style.minWidth = input.offsetWidth + "px";
      input.style.display = "none";
      input.parentNode.insertBefore(span, input);
      replaced.push({ input, span });
    });
    const buttons = node.querySelectorAll("button,.remove-btn");
    buttons.forEach(btn => btn.style.display = "none");

    const canvasImg = await html2canvas(node, { scale: 2, useCORS: true, backgroundColor: '#fff' });

    replaced.forEach(({ input, span }) => { span.remove(); input.style.display = ""; });
    buttons.forEach(btn => btn.style.display = "");

    if (type === 'pdf') {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'a4');
      const imgData = canvasImg.toDataURL('image/png');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save("invoice.pdf");
    } else {
      const mime = type === 'png' ? 'image/png' : 'image/jpeg';
      const dataURL = canvasImg.toDataURL(mime, 1.0);
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = `invoice.${type}`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }
</script>
</body>
</html>
